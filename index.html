<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX Resource - 리소스 관리 시스템</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #CBD5E1; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 text-sm">
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white;">
            <div class="loader"></div>
            <p style="margin-top: 20px; font-weight: bold; color: #4b5563;">시스템을 최적화하여 연결 중입니다...</p>
        </div>
    </div>

    <!-- 라이브러리 로드 (순서 엄수: PropTypes -> Recharts) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0LfujVe5IG5Z80Ov9-ARReoiVA7Jh0MI",
            authDomain: "dx-resource.firebaseapp.com",
            projectId: "dx-resource",
            storageBucket: "dx-resource.firebasestorage.app",
            messagingSenderId: "864855908479",
            appId: "1:864855908479:web:f827811956c7372350df4a",
            measurementId: "G-E9YQ36XJE2"
        };

        const appId = 'dx-resource-stable-v7';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.fb = { 
            auth, db, appId, 
            signInAnonymously, onAuthStateChanged,
            collection, doc, addDoc, deleteDoc, onSnapshot, updateDoc, writeBatch 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;

        // 직접 구현한 SVG 아이콘 (외부 라이브러리 충돌 방지)
        const Icons = {
            Edit: () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>),
            Trash: () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>),
            Check: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>),
            X: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>),
            Plus: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>),
            Lock: () => (<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>),
            Calendar: () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>),
            Download: () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>),
            ChevronRight: () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>)
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState('report');
            const [adminTab, setAdminTab] = useState('employees');
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            
            // 데이터 상태
            const [employees, setEmployees] = useState([]);
            const [projects, setProjects] = useState([]);
            const [ranks, setRanks] = useState([]);
            const [teams, setTeams] = useState([]);
            const [research, setResearch] = useState([]);
            const [resourceEntries, setResourceEntries] = useState([]);
            
            // 입력 상태
            const [inputRank, setInputRank] = useState('');
            const [inputTeam, setInputTeam] = useState('');
            const [inputPrj, setInputPrj] = useState('');
            const [inputRes, setInputRes] = useState('');
            const [empForm, setEmpForm] = useState({ n: '', r: '', t: '' });
            
            // 수정 상태 관리
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', rank: '', team: '' });
            const [editingMaster, setEditingMaster] = useState(null); 
            const [masterValue, setMasterValue] = useState('');

            const [selectedTeamFilter, setSelectedTeamFilter] = useState('전체');
            const [tempInputs, setTempInputs] = useState({});
            const [isActionLoading, setIsActionLoading] = useState(false);

            // --- 1. 초기화 및 인증 ---
            useEffect(() => {
                const checkFBReady = setInterval(() => {
                    if (window.fb && window.fb.onAuthStateChanged) {
                        clearInterval(checkFBReady);
                        window.fb.signInAnonymously(window.fb.auth).catch(e => console.error(e));
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                            if (u) { setUser(u); setLoading(false); }
                        });
                    }
                }, 100);
                return () => clearInterval(checkFBReady);
            }, []);

            // --- 2. 데이터 실시간 스트리밍 ---
            useEffect(() => {
                if (!user || !window.fb) return;
                const path = (n) => window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', n);
                const unsub = [
                    window.fb.onSnapshot(path('employees'), s => setEmployees(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    window.fb.onSnapshot(path('projects'), s => setProjects(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    window.fb.onSnapshot(path('ranks'), s => setRanks(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    window.fb.onSnapshot(path('teams'), s => setTeams(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    window.fb.onSnapshot(path('research'), s => setResearch(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    window.fb.onSnapshot(path('resourceEntries'), s => setResourceEntries(s.docs.map(d => ({ id: d.id, ...d.data() }))))
                ];
                return () => unsub.forEach(f => f());
            }, [user]);

            // --- 3. 비즈니스 로직 함수 ---

            const exportCSV = () => {
                if (resourceEntries.length === 0) { alert("추출할 데이터가 없습니다."); return; }
                const headers = ["주차", "성함", "직급", "소속팀", "항목", "시작일", "종료일", "투입률(%)", "업무요약"];
                const rows = resourceEntries.map(entry => {
                    const emp = employees.find(e => e.id === entry.empId) || { name: '-', rank: '-', team: '-' };
                    return [entry.week, emp.name, emp.rank, emp.team, entry.projectId, entry.startDate, entry.endDate, entry.rate, `"${(entry.desc || '').replace(/"/g, '""')}"` ];
                });
                const csvContent = ["\ufeff" + headers.join(","), ...rows.map(r => r.join(","))].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `DX_Resource_Extract_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const addMaster = async (e, col, value, setter) => {
                e.preventDefault();
                if (!value.trim()) return;
                setIsActionLoading(true);
                try {
                    await window.fb.addDoc(window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', col), { name: value.trim() });
                    setter(''); 
                } catch (err) { alert("저장 실패"); } finally { setIsActionLoading(false); }
            };

            const updateMaster = async () => {
                if (!editingMaster || !masterValue.trim()) return;
                setIsActionLoading(true);
                try {
                    await window.fb.updateDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', editingMaster.col, editingMaster.id), { name: masterValue.trim() });
                    setEditingMaster(null); // 수정 후 자동으로 편집창 닫기
                } catch (err) { alert("수정 실패"); } finally { setIsActionLoading(false); }
            };

            const deleteMaster = async (col, id) => {
                if (confirm('삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.')) {
                    await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', col, id));
                }
            };

            const addEmployee = async (e) => {
                e.preventDefault();
                if (!empForm.n || !empForm.r || !empForm.t) return;
                setIsActionLoading(true);
                try {
                    await window.fb.addDoc(window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'employees'), {
                        name: empForm.n, rank: empForm.r, team: empForm.t, createdAt: new Date().toISOString()
                    });
                    setEmpForm({ n: '', r: '', t: '' });
                } catch (err) { alert("등록 오류"); } finally { setIsActionLoading(false); }
            };

            const updateEmployee = async () => {
                if (!editingId) return;
                setIsActionLoading(true);
                try {
                    await window.fb.updateDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'employees', editingId), editForm);
                    setEditingId(null); // 수정 후 자동으로 편집창 닫기
                } catch (err) { alert("수정 오류"); } finally { setIsActionLoading(false); }
            };

            const batchSetup = async (col, names) => {
                setIsActionLoading(true);
                try {
                    const batch = window.fb.writeBatch(window.fb.db);
                    const colRef = window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', col);
                    names.forEach(name => { batch.set(window.fb.doc(colRef), { name }); });
                    await batch.commit();
                    alert("기본 정보가 일괄 등록되었습니다.");
                } catch (e) { alert("일괄 등록 오류"); } finally { setIsActionLoading(false); }
            };

            const saveResources = async () => {
                const now = new Date().toISOString();
                const week = `${new Date().getFullYear()}-W${Math.ceil(new Date().getDate() / 7)}`;
                const promises = [];
                Object.keys(tempInputs).forEach(eid => {
                    tempInputs[eid].forEach(row => {
                        if (row.rate > 0) {
                            // 프로젝트 코드가 '내부활동-DX본부'인 경우 세부 연구개발 항목을 합쳐서 저장하거나 구분함
                            const finalProjectId = row.projectId === '내부활동-DX본부' && row.subProjectId 
                                ? `[내부활동] ${row.subProjectId}` 
                                : row.projectId;
                            
                            promises.push(window.fb.addDoc(window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'resourceEntries'), { 
                                projectId: finalProjectId,
                                empId: eid, 
                                startDate: row.startDate,
                                endDate: row.endDate,
                                rate: row.rate,
                                desc: row.desc,
                                timestamp: now, 
                                week 
                            }));
                        }
                    });
                });
                setIsActionLoading(true);
                try { await Promise.all(promises); setTempInputs({}); alert("리소스가 저장되었습니다."); } finally { setIsActionLoading(false); }
            };

            // --- 4. 연산 데이터 ---
            const currentWeekStr = useMemo(() => `${new Date().getFullYear()}-W${Math.ceil(new Date().getDate() / 7)}`, []);
            
            const stats = useMemo(() => {
                const entries = resourceEntries.filter(e => e.week === currentWeekStr);
                const total = entries.reduce((s, r) => s + r.rate, 0);
                const combined = [...projects, ...research];
                return combined.map(c => {
                    const sum = entries.filter(e => e.projectId.includes(c.name)).reduce((s, r) => s + r.rate, 0);
                    return { name: c.name, value: sum, percent: total > 0 ? Math.round((sum/total)*100) : 0 };
                }).filter(d => d.value > 0);
            }, [resourceEntries, projects, research, currentWeekStr]);

            const statusTable = useMemo(() => {
                return employees.map(emp => {
                    const entries = resourceEntries.filter(re => re.empId === emp.id && re.week === currentWeekStr);
                    return { ...emp, total: entries.reduce((s, r) => s + r.rate, 0), list: entries.map(e => `${e.projectId}(${e.rate}%)`).join(', ') };
                });
            }, [employees, resourceEntries, currentWeekStr]);

            // --- 5. 렌더링 ---
            return (
                <div className="min-h-screen pb-20 font-black tracking-tight text-gray-800">
                    <nav className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-40 shadow-sm text-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black">D</div>
                            <span className="text-lg font-black uppercase">DX RESOURCE</span>
                        </div>
                        <div className="flex gap-1 bg-gray-100 p-1 rounded-2xl text-sm font-bold">
                            {['report', 'input', 'admin'].map(p => (
                                <button key={p} onClick={() => setCurrentPage(p)} className={`px-5 py-2 rounded-xl transition-all ${currentPage === p ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500'}`}>
                                    {p === 'report' ? '보고서' : p === 'input' ? '리소스 입력' : '관리자'}
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="p-4 md:p-8 max-w-7xl mx-auto space-y-10">
                        {/* 보고서 탭 */}
                        {currentPage === 'report' && (
                            <div className="space-y-8 fade-in">
                                <div className="flex justify-between items-end">
                                    <h2 className="text-3xl font-black">주간 분석 보고서</h2>
                                    <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-gray-100 text-xs font-bold text-gray-400 shadow-sm">
                                        <Icons.Calendar /> 금주: {currentWeekStr}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1 bg-white p-8 rounded-[40px] shadow-sm border border-gray-100 flex flex-col">
                                        <h3 className="text-lg mb-6 text-gray-700 font-black">참여 비중</h3>
                                        <div className="h-[250px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={stats} innerRadius={60} outerRadius={90} paddingAngle={5} dataKey="value">
                                                        {stats.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                                    </Pie>
                                                    <Tooltip />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="mt-4 space-y-2 text-sm font-bold">
                                            {stats.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center font-black"><span className="text-gray-500">{item.name}</span><span>{item.percent}%</span></div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-white rounded-[40px] shadow-sm border border-gray-100 overflow-hidden font-bold">
                                        <div className="p-8 border-b border-gray-50 bg-gray-50/30 text-lg font-black">본부원 투입 현황</div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left">
                                                <thead className="bg-gray-50 text-gray-400 uppercase text-xs font-black"><tr><th className="px-8 py-5">이름/소속</th><th className="px-8 py-5">항목</th><th className="px-8 py-5 text-center">투입률</th></tr></thead>
                                                <tbody className="divide-y divide-gray-50 font-black">
                                                    {statusTable.map(emp => (
                                                        <tr key={emp.id} className={emp.total <= 80 ? 'bg-red-50/50' : ''}>
                                                            <td className="px-8 py-6 font-black"><div className="font-black text-gray-800">{emp.name}</div><div className="text-xs text-gray-400 font-bold">{emp.rank} / {emp.team}</div></td>
                                                            <td className="px-8 py-6 text-xs text-gray-500 font-bold">{emp.list || '-'}</td>
                                                            <td className="px-8 py-6 text-center">
                                                                <div className={`text-base font-black ${emp.total <= 80 ? 'text-red-600' : 'text-blue-600'}`}>{emp.total}%</div>
                                                                <div className="w-full bg-gray-200 h-1 rounded-full mt-1 overflow-hidden font-black"><div className={`h-full ${emp.total <= 80 ? 'bg-red-500' : 'bg-blue-500'}`} style={{width: `${Math.min(emp.total, 100)}%`}}></div></div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 리소스 입력 탭 */}
                        {currentPage === 'input' && (
                            <div className="space-y-10 fade-in font-black">
                                <div className="flex justify-between items-center font-black">
                                    <h2 className="text-3xl font-black">리소스 실시간 입력</h2>
                                    <div className="flex gap-4">
                                        <select className="p-3 bg-white border-2 border-gray-100 rounded-2xl text-sm font-black outline-none shadow-sm" onChange={(e) => setSelectedTeamFilter(e.target.value)} value={selectedTeamFilter}>
                                            <option value="전체">전체 보기</option>
                                            {teams.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                        </select>
                                        <button onClick={saveResources} className="px-10 py-3.5 bg-blue-600 text-white rounded-2xl font-black shadow-xl hover:bg-blue-700 active:scale-95 transition-all text-sm font-black">리소스 일괄 저장</button>
                                    </div>
                                </div>
                                {employees.filter(e => selectedTeamFilter === '전체' || e.team === selectedTeamFilter).map(emp => (
                                    <div key={emp.id} className="bg-white rounded-[40px] shadow-sm border border-gray-100 overflow-hidden mb-8">
                                        <div className="bg-gray-50/50 px-8 py-6 flex justify-between items-center border-b border-gray-100 font-black">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-xl font-black">{emp.name[0]}</div>
                                                <div><span className="text-xl font-black font-black">{emp.name}</span><div className="text-xs text-gray-400 font-bold">{emp.rank} / {emp.team}</div></div>
                                            </div>
                                            <div className={`text-3xl font-black ${tempInputs[emp.id]?.reduce((s,r) => s+r.rate,0) > 100 ? 'text-red-600' : 'text-blue-600'}`}>{(tempInputs[emp.id]?.reduce((s,r) => s+r.rate,0) || 0)}%</div>
                                        </div>
                                        <div className="p-8 space-y-4 font-black">
                                            {(tempInputs[emp.id] || []).map((row, idx) => (
                                                <div key={idx} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-gray-50 p-6 rounded-3xl border border-gray-100">
                                                    <div className="md:col-span-3 font-bold font-black">
                                                        <label className="text-[10px] text-gray-400 block mb-2 font-black uppercase">참여 프로젝트</label>
                                                        <div className="space-y-2">
                                                            <select 
                                                                className="w-full p-4 bg-white border border-gray-200 rounded-2xl outline-none text-sm font-bold font-black" 
                                                                value={row.projectId} 
                                                                onChange={(e) => { 
                                                                    const rs = [...tempInputs[emp.id]]; 
                                                                    rs[idx].projectId = e.target.value; 
                                                                    if(e.target.value !== '내부활동-DX본부') rs[idx].subProjectId = '';
                                                                    setTempInputs({...tempInputs, [emp.id]: rs}); 
                                                                }}
                                                            >
                                                                <option value="">선택하세요</option>
                                                                {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                                            </select>
                                                            
                                                            {row.projectId === '내부활동-DX본부' && (
                                                                <div className="flex items-center gap-2 pl-2 border-l-4 border-blue-200 bg-blue-50/30 p-2 rounded-xl animate-in slide-in-from-left-2 duration-300">
                                                                    <Icons.ChevronRight />
                                                                    <select 
                                                                        className="flex-1 p-2 bg-white border border-blue-100 rounded-xl outline-none text-xs font-bold"
                                                                        value={row.subProjectId}
                                                                        onChange={(e) => {
                                                                            const rs = [...tempInputs[emp.id]];
                                                                            rs[idx].subProjectId = e.target.value;
                                                                            setTempInputs({...tempInputs, [emp.id]: rs});
                                                                        }}
                                                                    >
                                                                        <option value="">세부 제안/연구개발 선택</option>
                                                                        {research.map(r => <option key={r.id} value={r.name}>{r.name}</option>)}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="md:col-span-4 flex items-end gap-3 font-bold font-black">
                                                        <div className="flex-1 font-black font-black"><label className="text-[10px] text-gray-400 block mb-2 font-black font-black">시작일</label><input type="date" className="w-full p-4 bg-white border border-gray-200 rounded-2xl text-xs font-bold" value={row.startDate} onChange={(e) => { 
                                                            const rs = [...tempInputs[emp.id]]; rs[idx].startDate = e.target.value;
                                                            const d = new Date(e.target.value);
                                                            const diff = d.getDay() <= 5 ? 5 - d.getDay() : 5 + (7 - d.getDay());
                                                            d.setDate(d.getDate() + diff);
                                                            rs[idx].endDate = d.toISOString().split('T')[0];
                                                            setTempInputs({...tempInputs, [emp.id]: rs});
                                                        }} /></div>
                                                        <span className="mb-4 text-gray-300 font-black">~</span>
                                                        <div className="flex-1 font-black font-black font-black font-black font-black font-black font-black"><label className="text-[10px] text-gray-400 block mb-2 font-black font-black">종료일</label><input type="date" className="w-full p-4 bg-white border border-gray-200 rounded-2xl text-xs font-bold" value={row.endDate} onChange={(e) => { const rs = [...tempInputs[emp.id]]; rs[idx].endDate = e.target.value; setTempInputs({...tempInputs, [emp.id]: rs}); }} /></div></div>
                                                    <div className="md:col-span-1 text-center font-black font-black font-black"><label className="text-[10px] text-gray-400 block mb-2 font-black font-black">투입%</label><input type="number" step="5" className="w-full p-4 bg-white border border-gray-200 rounded-2xl text-center text-blue-600 text-sm font-black font-black" value={row.rate} onChange={(e) => { const rs = [...tempInputs[emp.id]]; rs[idx].rate = Number(e.target.value); setTempInputs({...tempInputs, [emp.id]: rs}); }} /></div>
                                                    <div className="md:col-span-4 font-bold flex gap-2 font-black font-black font-black font-black">
                                                        <div className="flex-1 font-black font-black font-black font-black font-black"><label className="text-[10px] text-gray-400 block mb-2 font-black">업무 상세 내용</label><input type="text" className="w-full p-4 bg-white border border-gray-200 rounded-2xl text-sm font-black font-black" placeholder="요약" value={row.desc} onChange={(e) => { const rs = [...tempInputs[emp.id]]; rs[idx].desc = e.target.value; setTempInputs({...tempInputs, [emp.id]: rs}); }} /></div>
                                                        <button onClick={() => { const rs = [...tempInputs[emp.id]]; rs.splice(idx,1); setTempInputs({...tempInputs, [emp.id]: rs}); }} className="p-4 text-gray-300 hover:text-red-500 transition-all font-black font-black font-black font-black font-black font-black"><Icons.Trash /></button>
                                                    </div>
                                                </div>
                                            ))}
                                            <button onClick={() => { const rs = tempInputs[emp.id] || []; setTempInputs({...tempInputs, [emp.id]: [...rs, {projectId:'', subProjectId: '', rate:0, desc:'', startDate:'', endDate:''}]}); }} className="w-full py-4 border-2 border-dashed border-gray-200 rounded-[28px] text-gray-400 hover:border-blue-300 hover:text-blue-600 transition-all font-bold flex items-center justify-center gap-2">
                                                <Icons.Plus /> 참여 항목 추가
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentPage === 'admin' && (
                            !isAdminAuth ? (
                                <div className="flex flex-col items-center justify-center h-[500px] fade-in font-black font-black">
                                    <div className="bg-white p-16 rounded-[60px] shadow-2xl border border-gray-100 w-full max-w-md mx-4 text-center font-black">
                                        <div className="mb-8 flex justify-center font-black font-black font-black"><Icons.Lock /></div>
                                        <h2 className="text-2xl font-black mb-8 font-black font-black font-black">ADMIN LOGIN</h2>
                                        <input type="password" onKeyUp={(e) => e.key === 'Enter' && (adminPassword === '9943' ? setIsAdminAuth(true) : alert('비밀번호 오류'))} className="w-full p-6 bg-gray-50 border-0 rounded-3xl mb-8 text-center text-3xl tracking-[0.5em] outline-none shadow-inner font-black font-black font-black" placeholder="••••" value={adminPassword} onChange={(e) => setAdminPassword(e.target.value)} />
                                        <button onClick={() => adminPassword === '9943' ? setIsAdminAuth(true) : alert('비밀번호 오류')} className="w-full bg-blue-600 text-white p-5 rounded-3xl text-xl shadow-2xl hover:bg-blue-700 active:scale-95 transition-all font-black">인증 진행</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-12 fade-in font-black">
                                    <div className="flex justify-between items-center font-black">
                                        <h2 className="text-3xl font-black font-black">본부 관리 패널</h2>
                                        <div className="flex gap-4 font-black">
                                            <button onClick={exportCSV} className="px-6 py-3 bg-emerald-500 text-white rounded-2xl text-xs font-black shadow-lg flex items-center gap-2 transition-all active:scale-95 font-black">
                                                <Icons.Download /> 데이터 추출(CSV)
                                            </button>
                                            <button onClick={() => setIsAdminAuth(false)} className="px-6 py-3 text-red-500 bg-red-50 rounded-2xl text-xs font-black hover:bg-red-100 transition-all font-black">로그아웃</button>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-10 border-b-2 border-gray-100 font-bold text-gray-400">
                                        <button onClick={() => setAdminTab('employees')} className={`pb-4 px-2 transition-all border-b-4 ${adminTab === 'employees' ? 'border-blue-600 text-blue-600 font-black' : 'border-transparent'}`}>본부 구성원 관리</button>
                                        <button onClick={() => setAdminTab('masters')} className={`pb-4 px-2 transition-all border-b-4 ${adminTab === 'masters' ? 'border-blue-600 text-blue-600 font-black' : 'border-transparent'}`}>기본 정보 관리</button>
                                    </div>

                                    {adminTab === 'employees' ? (
                                        <div className="space-y-10 font-black">
                                            <div className="bg-white p-10 rounded-[40px] shadow-sm border border-gray-100 font-black">
                                                <h3 className="text-xl mb-10 text-blue-600 font-black font-black">신규 직원 등록</h3>
                                                <form onSubmit={addEmployee} className="grid grid-cols-1 md:grid-cols-4 gap-6 items-end font-black text-sm">
                                                    <div><label className="text-xs text-gray-400 mb-2 block uppercase font-black font-black">성함</label><input value={empForm.n} onChange={e => setEmpForm({...empForm, n: e.target.value})} className="w-full p-4 bg-gray-50 border-0 rounded-2xl outline-none shadow-inner font-black" required /></div>
                                                    <div><label className="text-xs text-gray-400 mb-2 block uppercase font-black font-black font-black">직급</label><select value={empForm.r} onChange={e => setEmpForm({...empForm, r: e.target.value})} className="w-full p-4 bg-gray-50 border-0 rounded-2xl outline-none shadow-inner font-black" required><option value="">선택</option>{ranks.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></div>
                                                    <div><label className="text-xs text-gray-400 mb-2 block uppercase font-black font-black font-black">팀</label><select value={empForm.t} onChange={e => setEmpForm({...empForm, t: e.target.value})} className="w-full p-4 bg-gray-50 border-0 rounded-2xl outline-none shadow-inner font-black" required><option value="">선택</option>{teams.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></div>
                                                    <button className="bg-blue-600 text-white p-5 rounded-2xl shadow-xl h-14 font-black">등록 완료</button>
                                                </form>
                                            </div>
                                            <div className="bg-white rounded-[40px] shadow-sm border border-gray-100 overflow-hidden font-black">
                                                <div className="p-10 border-b border-gray-50 bg-gray-50/20 font-black text-lg">전체 직원 리스트 ({employees.length}명)</div>
                                                <div className="overflow-x-auto font-black font-black">
                                                    <table className="w-full text-left font-black">
                                                        <thead className="bg-gray-50 text-gray-400 uppercase text-xs font-black tracking-widest"><tr><th className="px-10 py-6">성함</th><th className="px-10 py-6">직급</th><th className="px-10 py-6">소속 팀</th><th className="px-10 py-6 text-right font-black">관리</th></tr></thead>
                                                        <tbody className="divide-y divide-gray-50 text-sm font-black">
                                                            {employees.map(e => (
                                                                <tr key={e.id} className={`group hover:bg-blue-50/30 transition-all ${editingId === e.id ? 'bg-blue-50 font-black font-black' : ''}`}>
                                                                    {editingId === e.id ? (
                                                                        <>
                                                                            <td className="px-10 py-4 font-black font-black"><input value={editForm.name} onChange={v => setEditForm({...editForm, name: v.target.value})} className="p-2 border rounded-xl w-full font-black outline-none bg-white font-black" /></td>
                                                                            <td className="px-10 py-4 font-black font-black font-black"><select value={editForm.rank} onChange={v => setEditForm({...editForm, rank: v.target.value})} className="p-2 border rounded-xl w-full font-black outline-none bg-white font-black">{ranks.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></td>
                                                                            <td className="px-10 py-4 font-black font-black font-black"><select value={editForm.team} onChange={v => setEditForm({...editForm, team: v.target.value})} className="p-2 border rounded-xl w-full font-black outline-none bg-white font-black font-black">{teams.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></td>
                                                                            <td className="px-10 py-4 text-right flex justify-end gap-2 font-black font-black"><button onClick={updateEmployee} className="p-2 bg-blue-600 text-white rounded-lg font-black font-black font-black"><Icons.Check /></button></td>
                                                                        </>
                                                                    ) : (
                                                                        <>
                                                                            <td className="px-10 py-6 text-gray-800 font-black font-black">{e.name}</td>
                                                                            <td className="px-10 py-6 text-gray-500 font-black font-black font-black">{e.rank}</td>
                                                                            <td className="px-10 py-6 text-gray-500 font-black font-black font-black">{e.team}</td>
                                                                            <td className="px-10 py-6 text-right font-black font-black font-black">
                                                                                <div className="flex justify-end gap-3 opacity-0 group-hover:opacity-100 transition-all font-black font-black">
                                                                                    <button onClick={() => { setEditingId(e.id); setEditForm({name: e.name, rank: e.rank, team: e.team}); }} className="p-2 text-blue-500 hover:bg-blue-100 rounded-lg font-black font-black font-black"><Icons.Edit /></button>
                                                                                    <button onClick={() => deleteMaster('employees', e.id)} className="p-2 text-gray-300 hover:text-red-500 font-black font-black font-black"><Icons.Trash /></button>
                                                                                </div>
                                                                            </td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 font-black text-sm">
                                            {[
                                                { title: '직급 및 직책', col: 'ranks', items: ranks, color: 'purple', setup: ['본부장', '팀장', '책임', '선임', '매니저'], btn: '표준 직급 자동 등록', val: inputRank, set: setInputRank },
                                                { title: '팀 구성', col: 'teams', items: teams, color: 'blue', setup: ['본부장', '기획', 'PM', '디자인', '시스템'], btn: '2026년 1월 팀구성', val: inputTeam, set: setInputTeam },
                                                { title: '프로젝트 정보', col: 'projects', items: projects, color: 'orange', val: inputPrj, set: setInputPrj },
                                                { title: 'DX제안 및 연구개발', col: 'research', items: research, color: 'emerald', val: inputRes, set: setInputRes }
                                            ].map((m, idx) => (
                                                <div key={idx} className="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100 flex flex-col font-black font-black font-black">
                                                    <div className="flex justify-between items-center mb-6 font-black font-black font-black">
                                                        <h3 className={`font-black text-xl text-${m.color}-600 font-black`}>{m.title}</h3>
                                                        {m.btn && <button onClick={() => batchSetup(m.col, m.setup)} className={`text-[10px] bg-${m.color}-50 text-${m.color}-600 px-3 py-1.5 rounded-xl font-black`}>{m.btn}</button>}
                                                    </div>
                                                    <form onSubmit={(e) => addMaster(e, m.col, m.val, m.set)} className="flex gap-2 mb-6 font-black font-black font-black font-black font-black">
                                                        <input value={m.val} onChange={e => m.set(e.target.value)} placeholder="새 항목 입력" className="flex-1 p-4 bg-gray-50 border-0 rounded-2xl outline-none font-black shadow-inner font-black" required />
                                                        <button className={`bg-${m.color}-600 text-white px-6 rounded-2xl font-black text-xs h-14`}>추가</button>
                                                    </form>
                                                    <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar font-black font-black">
                                                        {m.items.map(item => (
                                                            <div key={item.id} className={`flex justify-between items-center p-4 rounded-2xl border-2 transition-all font-black font-black font-black ${editingMaster?.id === item.id ? `border-${m.color}-400 bg-white font-black font-black` : 'border-transparent bg-gray-50'}`}>
                                                                {editingMaster?.id === item.id ? (
                                                                    <div className="flex gap-2 w-full font-black font-black font-black font-black font-black font-black"><input value={masterValue} onChange={e => setMasterValue(e.target.value)} className="flex-1 p-1 border-b-2 outline-none font-black font-black font-black" /><button onClick={updateMaster} className="text-blue-600 font-black font-black font-black font-black"><Icons.Check /></button></div>
                                                                ) : (
                                                                    <><span className="truncate mr-4 font-black font-black font-black">{item.name}</span><div className="flex gap-1 font-black font-black font-black"><button onClick={() => { setEditingMaster({id:item.id, col:m.col}); setMasterValue(item.name); }} className="p-1.5 text-blue-400 font-black font-black font-black font-black"><Icons.Edit /></button><button onClick={() => deleteMaster(m.col, item.id)} className="p-1.5 text-red-300 font-black font-black font-black font-black font-black font-black"><Icons.Trash /></button></div></>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )
                        )}
                    </main>
                    <footer className="mt-20 py-16 border-t-2 border-gray-100 text-center text-gray-400 font-black tracking-widest text-xs uppercase font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">© 2026 DX Resource · Managed Service</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
